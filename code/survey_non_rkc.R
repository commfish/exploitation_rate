#  Code to assign RKC stat areas into "survey" or "non" groups.
#   Currently uses data obtained from fish ticket in ALEX query of:
#     red and blue king crab (species 921, 922), registration area A, all fish ticket years 

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-3-23

# load ---
source('./code/packages.R')

# data -----
## if using ALEX output use this file
harvest <- read.xlsx('data/RKC and BKC historical data - Reg Area A.xlsx', sheetName = "Rinput")

# file to convert stat areas into survey areas
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")


## data clean up - ALEX harvest file -----------
harvest %>% 
  rename(year = YEAR, cdate = CATCH_DATE, season = SEASON, numbers = NUMBERS, pounds = POUNDS) %>% 
  select(year, TICKET_NO, cdate, season, I_FISHERY, STAT_AREA, DISTRICT, SUB_DISTRICT, 
         SPECIES_CODE, numbers, pounds, POTS) -> harvest_all

## file for use by others------
harvest %>% 
  left_join(survey.area) %>% 
  mutate(area_type = ifelse(is.na(survey.area), "non", "survey"))-> harvest_file1

write.csv(harvest_file1, './results/all_years_harvest_survey_non.csv')

## survey vs non totals ---
harvest_all %>%
  left_join(survey.area) %>% 
  mutate(area_type = ifelse(is.na(survey.area), "non", "survey")) -> harvest_area_type

harvest_area_type %>% 
  group_by(season, area_type) %>% 
  summarise(pounds = sum(pounds, na.rm = TRUE)) %>% 
  filter(!is.na(season)) ->harvest_by_year

ggplot(harvest_by_year, aes(season, pounds, fill = area_type)) +
  geom_bar(stat="identity")
## percentages by year -----
harvest_by_year %>% 
  spread(area_type, pounds) -> pounds_yr # values here are in pounds

pounds_yr %>% 
  mutate(total_harvest = non + survey, pct.survey = survey/total_harvest, 
         pct.non = 1-pct.survey) -> pounds_yr_pct
write.csv(pounds_yr_pct, './results/percentage_harvest_survey_non.csv')

pounds_yr_pct %>% 
  select(season, pct.survey, pct.non) %>% 
  gather("area_type", "percentage", 2:3) %>% 
  ggplot(aes(season, percentage, fill = area_type)) + geom_bar(stat = "identity")


#### graph by year  -----
# need to read in updated data file since I want a value for year season/year....
pct.graph <- read.csv('data/percentage_harvest_survey_non_edited.csv')

pct.graph %>% 
  select(year_ref, pct.survey, pct.non) %>% 
  gather("area_type", "percentage", 2:3) %>% 
  ggplot(aes(year_ref, percentage, fill = area_type)) + geom_bar(stat = "identity")
  
# add fishery openings and closures 
pct.graph %>% 
  mutate(fishery.status = ifelse(year_ref > 1984 & year_ref < 1993, "closed", ifelse(
    year_ref == 1998, "closed", ifelse(year_ref == 2000, "closed", ifelse(
      year_ref == 2004, "closed", ifelse(year_ref >2005 & year_ref < 2011, "closed", ifelse(
        year_ref > 2011 & year_ref < 2017, "closed", "open"
      ))
    ))
  ))) -> pct.graph
write.csv(pct.graph, './results/harvest_survey_non_final.csv')

pct.graph %>% 
  select(year_ref, fishery.status, pct.survey, pct.non) %>% 
  gather("area_type", "percentage", 3:4) %>% 
  mutate(percentage = ifelse(fishery.status == "open", percentage, 0)) %>% 
  ggplot(aes(year_ref, percentage, fill = area_type)) + 
  geom_bar(stat = "identity") + ylab("season") -> figure_open_only

png('./results/percentage_survey_rkc.png', res = 400, width = 8, height =4, unit = 'in')
figure_open_only
dev.off()


## proposed percentages -----
pct.graph %>% 
  filter(year_ref > 1992 & year_ref < 2005) %>% 
  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
  mutate(years = '1993 - 2004') -> modern.survey

#pct.graph %>% 
#  filter(year_ref > 1977 & year_ref < 1986) %>% 
#  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
#  mutate(years = '1978 - 1985') -> historic.survey

pct.graph %>% 
  filter(year_ref > 1975 & year_ref < 1985) %>% 
  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
  mutate(years = '1974 - 1984') -> historic.survey

#pct.graph %>% 
#  filter(year_ref > 1978) %>% 
#  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
#  mutate(years = '1979 - 2017') -> total.survey

pct.graph %>% 
  filter(year_ref > 1992 & year_ref < 2008) %>% 
  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
  mutate(years = '1993 - 2007') -> base.survey

pct.graph %>% 
  filter(year_ref > 1968) %>% 
  summarise(avg.survey = mean(pct.survey, na.rm = TRUE)) %>% 
  mutate(years = '1969 - 2017') -> all.survey


base.survey %>% 
  bind_rows(historic.survey) %>% 
  bind_rows(all.survey) %>%
  #bind_rows(base.survey) %>% 
  select(years, avg.survey)
