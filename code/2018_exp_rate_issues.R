# This addresses issues with the exploitation rate analysis in 2018.  
# This analysis uses southeast alaksa red king crab data. But could be applied to other populations.

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-4-17

# load ---
source('./code/packages.R')

# data -----
# Data is sourced from three place.  1) Annual biomas estimates are from the output of the CSA model for each area
#     in 2017 (stored in excel files for sharability with name of area). 
#  2) Harvest is taken from fish tickets
#     the files here are from the old fish ticket data base (prior to 1985) and the new database. OR
#         option file is from ALEX with all years combined.
#       **FLAG** These values need to be checked with ALEX output to make sure they are pulling the correct harvest

#  personal use summary is take from statewide harvest survey data and permit data in Juneau area
#     these are summarized in an excel file: Catch 2017_Analysis_updated from 2005.xls

biomass <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet1") 
# file to convert stat areas into survey areas
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")

## if using OceanAK use these files - old and new databases seperate
harvest1 <- read.csv('data/old_fish_tickets.csv')
harvest2 <- read.csv('data/fish_tickest_rkc_newer.csv')

## if using ALEX output use this file
harvest <- read.xlsx('data/RKC and BKC historical data - Reg Area A.xlsx', sheetName = "Rinput")

# file for adjustments between mark recapture and CSA biomass estimates.  Results of the mark-
#   recapture analysis - this is taken directly from the output of that in it's R project
adjustments <- read.csv('data/adj_final_stock_assessment.csv')

# personal use data, from excel file. Include numbers of crab and legal weight from survey
#     convert to pounds.
per_use <- read.xlsx('data/personal_use_all.xlsx', sheetName = "Sheet1")

# data clean up with Ocean AK data--------
# old fish ticket data base
harvest1 %>% 
  rename(year = Ã¯..Year.Landed, stat.area = Stat.Area, pounds = Pounds, species = Species.Code) %>% 
  mutate(season = ifelse(Month.Landed >=7, year, year-1)) ->harvest1
# after consulting with Karla and BOF report season most likely started around July and went until the next spring.

harvest1 %>% 
  group_by(season, stat.area, species) %>% 
  summarise(pounds = sum(pounds)) -> harvest_74_84

# new fish ticket data base
harvest2 %>% 
  rename(year = DOL.Year, stat.area = Stat.Area, pounds = Landed.Weight..sum., species.name = Species.Name) %>% 
  mutate(season = ifelse(DOL.Month >=7, year, year-1)) ->harvest2

harvest2 %>% 
  group_by(season, stat.area, species.name) %>% 
  summarise(pounds = sum(pounds)) -> harvest_88_17

# create one file for harvest.  Old one has species code, new one has species name
harvest_74_84 %>% 
  select(-species) -> harv_a
harvest_88_17 %>% 
  select(-species.name) -> harv_b

harv_a %>% 
  bind_rows(harv_b) -> harvest_oak



