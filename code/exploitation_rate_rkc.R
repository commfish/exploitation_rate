# redo of a 2013 analysis looking at an "equlibrium" harvest rate (a harvest rate where the overall change in 
#     in the population would be 0).
# This analysis uses southeast alaksa red king crab data. But could be applied to other populations.

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-3-23

# load ---
source('./code/packages.R')

# data -----
# Data is sourced from two place.  Annual biomas estimates are from the output of the CSA model for each area
#     in 2017 (stored in excel files for sharability with name of area). Harvest is taken from fish tickets
#     the files here are from the old fish ticket data base (prior to 1985) and the new database.  
#       **FLAG** These values need to be checked with ALEX output to make sure they are pulling the correct harvest

biomass <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet1") 
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")

harvest1 <- read.csv('data/old_fish_tickets.csv')
harvest2 <- read.csv('data/fish_tickest_rkc_newer.csv')

adjustments <- read.csv('data/adj_final_stock_assessment.csv')
  

# data clean up --------
# old fish ticket data base
harvest1 %>% 
  rename(year = Ã¯..Year.Landed, stat.area = Stat.Area, pounds = Pounds, species = Species.Code) %>% 
  mutate(season = ifelse(Month.Landed >=7, year, year-1)) ->harvest1
# after consulting with Karla and BOF report season most likely started around July and went until the next spring.

harvest1 %>% 
  group_by(season, stat.area, species) %>% 
  summarise(pounds = sum(pounds)) -> harvest_74_84

# new fish ticket data base
harvest2 %>% 
  rename(year = DOL.Year, stat.area = Stat.Area, pounds = Landed.Weight..sum., species.name = Species.Name) %>% 
  mutate(season = ifelse(DOL.Month >=7, year, year-1)) ->harvest2

harvest2 %>% 
  group_by(season, stat.area, species.name) %>% 
  summarise(pounds = sum(pounds)) -> harvest_88_17

# create one file for harvest.  Old one has species code, new one has species name
harvest_74_84 %>% 
  select(-species) -> harv_a
harvest_88_17 %>% 
  select(-species.name) -> harv_b

harv_a %>% 
  bind_rows(harv_b) -> harvest

## assign ---
## assign stat areas with harvest

harvest %>% 
  left_join(survey.area) -> test

## summary by year and survey area ----
# group by survey area and year

test %>% 
  group_by(suvery.area, season) %>% 
  summarise(pounds = sum(pounds, na.rm = TRUE)) %>% 
  filter( !is.na(suvery.area)) %>% 
  mutate(area = suvery.area)-> harvest_by_sa

## biomass and harvest combined -----
biomass %>% 
  mutate(season = year) -> biomass


biomass %>% 
  left_join(harvest_by_sa) %>% 
  mutate(hrate = pounds/mature) %>% 
  mutate(hrate2 = ifelse(is.na(hrate), 0, hrate)) -> bio_har_allareas # need to replace NA in hrate with 0 to show no harvest

# this doesn't work when all areas are combined....can do this one I seperate out area
# added column for mature biomass in the next year to make these calculations easier. Mature_1 is mature year +1


## Lynn Sisters -----
# use this area as example and then do analysis for all areas
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "St_James")

bio_har_allareas %>% 
  filter(area == "lynn") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 1.746833*mature, adj_hrate2 =  ifelse(!is.na(pounds), (pounds/adj_mature), 0)) %>% 
  filter(year < 2017) -> lynn

# lynn visualization ----
ggplot(lynn, aes(adj_hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)


# Lynn  linear regression -----
lynn_fit <- lm(change_b ~ adj_hrate2, data = lynn)
summary(lynn_fit)


# Equilibrium harvest rate ------
# when y = 0
# (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2])

#summary(lynn_fit)$coefficients
#summary(lynn_fit)$r.squared

# building lynn results....add to this? 
results <- data.frame(cbind("lynn", summary(lynn_fit)$coefficients[2,4], summary(lynn_fit)$r.squared, 
      (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2]),
      mean(lynn$adj_hrate2),mean(lynn$change_b)))

rownames(results) <- c("adj.hr")
colnames(results) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")

### Pybus  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Pybus")

bio_har_allareas %>% 
  filter(area == "pybus") %>% 
  mutate(mature_1 = c(mature[2:40], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.080614*mature, adj_hrate2 =  ifelse(!is.na(pounds), (pounds/adj_mature), 0)) %>% 
  filter(year < 2017) -> pybus

# visualization ----
ggplot(pybus, aes(adj_hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
pybus_fit <- lm(change_b ~ adj_hrate2, data = pybus)
summary(pybus_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2])

# summary of results...add to results above????? 
pb <- data.frame(cbind("pybus", summary(pybus_fit)$coefficients[2,4], summary(pybus_fit)$r.squared, 
                 (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2]),
                 mean(pybus$adj_hrate2),mean(pybus$change_b)))

colnames(pb) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")

results %>% 
  rbind(pb) ->results_all

### Gambier  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Gambier")

bio_har_allareas %>% 
  filter(area == "gambier") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.929303*mature, adj_hrate2 =  ifelse(!is.na(pounds), (pounds/adj_mature), 0)) %>% 
  filter(year < 2017) -> gambier

# visualization ----
ggplot(gambier, aes(adj_hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
gambier_fit <- lm(change_b ~ adj_hrate2, data = gambier)
summary(gambier_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2])

# summary of results...add to results above????? 
gb <- data.frame(cbind("gambier", summary(gambier_fit)$coefficients[2,4], summary(gambier_fit)$r.squared, 
                       (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2]),
                       mean(gambier$adj_hrate2),mean(gambier$change_b)))

colnames(gb) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")

results_all %>% 
  rbind(gb) ->results_all

### Seymour  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Seymour")

bio_har_allareas %>% 
  filter(area == "seymour") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 9.174725*mature, adj_hrate2 =  ifelse(!is.na(pounds), (pounds/adj_mature), 0)) %>% 
  filter(year < 2017) -> seymour

# visualization ----
ggplot(seymour, aes(adj_hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
seymour_fit <- lm(change_b ~ adj_hrate2, data = seymour)
summary(seymour_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2])

# summary of results...add to results above????? 
sc <- data.frame(cbind("seymour", summary(seymour_fit)$coefficients[2,4], summary(seymour_fit)$r.squared, 
                       (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2]),
                       mean(seymour$adj_hrate2),mean(seymour$change_b)))

colnames(sc) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")

results_all %>% 
  rbind(sc) ->results_all

### Peril  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Peril")

bio_har_allareas %>% 
  filter(area == "peril") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 9.174725*mature, adj_hrate2 =  ifelse(!is.na(pounds), (pounds/adj_mature), 0)) %>% 
  filter(year < 2017) -> seymour

# visualization ----
ggplot(seymour, aes(adj_hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
seymour_fit <- lm(change_b ~ adj_hrate2, data = seymour)
summary(seymour_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2])

# summary of results...add to results above????? 
sc <- data.frame(cbind("seymour", summary(seymour_fit)$coefficients[2,4], summary(seymour_fit)$r.squared, 
                       (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2]),
                       mean(seymour$adj_hrate2),mean(seymour$change_b)))

colnames(sc) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")

results_all %>% 
  rbind(sc) ->results_all