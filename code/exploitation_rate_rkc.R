# redo of a 2013 analysis looking at an "equlibrium" harvest rate (a harvest rate where the overall change in 
#     in the population would be 0).
# This analysis uses southeast alaksa red king crab data. But could be applied to other populations.

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-3-23

# load ---
source('./code/packages.R')

# data -----
# Data is sourced from three place.  1) Annual biomas estimates are from the output of the CSA model for each area
#     in 2017 (stored in excel files for sharability with name of area). 
 #  2) Harvest is taken from fish tickets
#     the files here are from the old fish ticket data base (prior to 1985) and the new database. OR
#         option file is from ALEX with all years combined.
#       **FLAG** These values need to be checked with ALEX output to make sure they are pulling the correct harvest

#  personal use summary is take from statewide harvest survey data and permit data in Juneau area
#     these are summarized in an excel file: Catch 2017_Analysis_updated from 2005.xls

biomass <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet1") 
# file to convert stat areas into survey areas
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")

## if using OceanAK use these files - old and new databases seperate
#harvest1 <- read.csv('data/old_fish_tickets.csv')
#harvest2 <- read.csv('data/fish_tickest_rkc_newer.csv')

## if using ALEX output use this file
harvest <- read.xlsx('data/RKC and BKC historical data - Reg Area A.xlsx', sheetName = "Rinput")

# file for adjustments between mark recapture and CSA biomass estimates.  Results of the mark-
#   recapture analysis - this is taken directly from the output of that in it's R project
adjustments <- read.csv('data/adj_final_stock_assessment.csv')

# personal use data, from excel file. Include numbers of crab and legal weight from survey
#     convert to pounds.
per_use <- read.xlsx('data/personal_use_all.xlsx', sheetName = "Sheet1")

# data clean up with Ocean AK data--------
# old fish ticket data base
#harvest1 %>% 
#  rename(year = Ã¯..Year.Landed, stat.area = Stat.Area, pounds = Pounds, species = Species.Code) %>% 
#  mutate(season = ifelse(Month.Landed >=7, year, year-1)) ->harvest1
# after consulting with Karla and BOF report season most likely started around July and went until the next spring.

#harvest1 %>% 
#  group_by(season, stat.area, species) %>% 
#  summarise(pounds = sum(pounds)) -> harvest_74_84

# new fish ticket data base
#harvest2 %>% 
#  rename(year = DOL.Year, stat.area = Stat.Area, pounds = Landed.Weight..sum., species.name = Species.Name) %>% 
#  mutate(season = ifelse(DOL.Month >=7, year, year-1)) ->harvest2

#harvest2 %>% 
#  group_by(season, stat.area, species.name) %>% 
#  summarise(pounds = sum(pounds)) -> harvest_88_17

# create one file for harvest.  Old one has species code, new one has species name
#harvest_74_84 %>% 
#  select(-species) -> harv_a
#harvest_88_17 %>% 
#  select(-species.name) -> harv_b

#harv_a %>% 
#  bind_rows(harv_b) -> harvest_oak

## data clean up - ALEX harvest file -----------
harvest %>% 
  rename(year = YEAR, cdate = CATCH_DATE, season = SEASON, numbers = NUMBERS, pounds = POUNDS) %>% 
  select(year, TICKET_NO, ADFG_NO, cdate, season, I_FISHERY, STAT_AREA, DISTRICT, SUB_DISTRICT, 
         SPECIES_CODE, numbers, pounds, POTS) -> harvest_all

## file for use by others------  see survey_non_rkc.R 
#harvest %>% 
#  left_join(survey.area) %>% 
#  mutate(area_type = ifelse(is.na(survey.area), "non", "survey"))-> harvest_file1

#write.csv(harvest_file1, './results/all_years_harvest_survey_non.csv')
## assign ------
## assign stat areas with harvest

harvest_all %>% 
  left_join(survey.area) %>% 
  mutate(area_type = ifelse(is.na(survey.area), "non", "survey")) -> harvest_all_areas

# confidential by area and year ------
harvest_all_areas %>% 
  group_by(survey.area, year) %>% 
  summarise(permits = n_distinct(ADFG_NO, na.rm = TRUE)) -> confidential


## summary by year and survey area ----
# group by survey area and year

harvest_all_areas %>% 
  group_by(survey.area, season) %>% 
  summarise(pounds = sum(pounds, na.rm = TRUE)) %>% 
  filter( !is.na(survey.area)) %>% 
  mutate(area = survey.area)-> harvest_by_sa


# need a season reference column in terms of years
library(stringr)
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
} 

harvest_by_sa %>% 
  mutate(year = as.numeric(ifelse(season == "Jan1969 - Aug69", 1968, numextract(season)))) -> harvest_by_sa

## biomass and harvest combined -----

biomass %>% 
  left_join(harvest_by_sa) ->bio_har1
  
# Need to add personal use AFTER harvest is combined with biomass because there is PU harvest 
##      years WITHOUT commericial harvest and these will get lost.
per_use %>% 
  mutate(pu_pounds = pu_number * legal_weight) -> per_use

# summary of biomass estimates, harvest (commercial and PU), with calculated total pounds (harvest removed) and
##      calculated harvest rates
bio_har1 %>% 
  left_join(per_use) %>% 
  mutate(pounds = ifelse(!is.na(pounds), pounds, 0)) %>% 
  mutate(total_pounds = ifelse(!is.na(pu_pounds), 
                               pounds + pu_pounds, pounds)) %>% 
  mutate(hrate = total_pounds/mature)  -> bio_har_allareas
  # need to replace NA in hrate with 0 to show no harvest

# FOR all areas:  
# added column for mature biomass in the next year to make these calculations easier. Mature_1 is mature year +1

## Lynn Sisters -----
# use this area as example and then do analysis for all areas
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "St_James") # change value in below code to be specific to the area used.

bio_har_allareas %>% 
  filter(area == "lynn") %>%  
  # added column for mature biomass in the next year to make these calculations easier. Mature_1 is mature year +1
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 1.746833*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> lynn

# lynn visualization ----
lynn_fig <- ggplot(lynn, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.097) +
  ggtitle("Lynn Sisters") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")

# save plot for text document
png('./figures/lynn_sisters.png', res= 300, width = 6.5, height = 4.0, units = "in")
lynn_fig
dev.off()

# Lynn  linear regression -----
lynn_fit <- lm(change_b ~ adj_hrate, data = lynn)
summary(lynn_fit)

lynn_parm_conf <- as.data.frame(confint(lynn_fit))
(-lynn_parm_conf[1,1]/lynn_parm_conf[2,1])
(-lynn_parm_conf[1,2]/lynn_parm_conf[2,2])
#d = data.frame(lynn, predict(lynn_fit, interval = "prediction"))
#d$residuals = residuals(lynn_fit)

#ggplot(d, aes(adj_hrate, change_b)) +
#  geom_line(aes(y=lwr), color = "red", linetype = "dashed") +
#  geom_line(aes(y=upr), color = "red", linetype = "dashed") +
#  geom_smooth(method =  "lm", aes(fill = 'confidence'), alpha =0.3) +
#  geom_smooth(method = "lm", se=FALSE, color = 'blue') +
#  geom_point() 
#summary(lynn_fit)$coefficients
#summary(lynn_fit)$r.squared

# Equilibrium harvest rate ------
# when y = 0
# (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.10 = (2*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.20 = (4*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (lynn_fit$coefficients[2]*0.20) + lynn_fit$coefficients[1]

## average harvest rate when population increased
lynn %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr


# building lynn results....add to this? 
ls <- data.frame(cbind("lynn", summary(lynn_fit)$coefficients[2,4], summary(lynn_fit)$r.squared, 
      (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2]),
      mean(lynn$adj_hrate),mean(lynn$change_b)), x.05, x.10, y.20, inc_avg_hr, 
      mean(lynn$mature))

rownames(ls) <- c("adj.hr")
colnames(ls) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                       "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")

### Pybus  -----
adjustments %>% 
  filter(area == "Pybus")

bio_har_allareas %>% 
  filter(area == "pybus") %>% 
  mutate(mature_1 = c(mature[2:40], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.080614*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> pybus

# visualization ----
pybus_fig <- ggplot(pybus, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.129) +
  ggtitle("Pybus") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")
# save plot for text document
png('./figures/pybus.png', res= 300, width = 6.5, height = 4.0, units = "in")
pybus_fig
dev.off()
# linear regression ----
pybus_fit <- lm(change_b ~ adj_hrate, data = pybus)
summary(pybus_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]
x.10 = (2*pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]
x.20 = (4*pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (pybus_fit$coefficients[2]*0.20) + pybus_fit$coefficients[1]

## average harvest rate when population increased
pybus %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr

# summary of results...add to results above????? 
pb <- data.frame(cbind("pybus", summary(pybus_fit)$coefficients[2,4], summary(pybus_fit)$r.squared, 
                 (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2]),
                 mean(pybus$adj_hrate),mean(pybus$change_b)), x.05, x.10, y.20, 
                 inc_avg_hr, mean(pybus$mature))

colnames(pb) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")
rownames(pb) <- c("adj.hr")

### Gambier  -----
adjustments %>% 
  filter(area == "Gambier")

bio_har_allareas %>% 
  filter(area == "gambier") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.929303*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> gambier

# visualization ----
gambier_fig <- ggplot(gambier, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.047) +
  ggtitle("Gambier") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")
# save plot for text document
png('./figures/gambier.png', res= 300, width = 6.5, height = 4.0, units = "in")
gambier_fig
dev.off()

# linear regression ----
gambier_fit <- lm(change_b ~ adj_hrate, data = gambier)
summary(gambier_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - gambier_fit$coefficients[1])/gambier_fit$coefficients[2]
x.10 = (2*pct.change - gambier_fit$coefficients[1])/gambier_fit$coefficients[2]
x.20 = (4*pct.change - gambier_fit$coefficients[1])/gambier_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (gambier_fit$coefficients[2]*0.20) + gambier_fit$coefficients[1]

## average harvest rate when population increased
gambier %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr

# summary of results...add to results above????? 
gb <- data.frame(cbind("gambier", summary(gambier_fit)$coefficients[2,4], summary(gambier_fit)$r.squared, 
                       (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2]),
                       mean(gambier$adj_hrate),mean(gambier$change_b)),x.05, x.10, y.20, 
                 inc_avg_hr, mean(gambier$mature))

colnames(gb) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")
rownames(gb) <- c("adj.hr")

### Seymour  -----
adjustments %>% 
  filter(area == "Seymour")

bio_har_allareas %>% 
  filter(area == "seymour") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 9.174725*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> seymour

# visualization ----
seymour_fig <- ggplot(seymour, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.015) +
  ggtitle("Seymour") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")
# save plot for text document
png('./figures/seymour.png', res= 300, width = 6.5, height = 4.0, units = "in")
seymour_fig
dev.off()
# linear regression ----
seymour_fit <- lm(change_b ~ adj_hrate, data = seymour)
summary(seymour_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - seymour_fit$coefficients[1])/seymour_fit$coefficients[2]
x.10 = (2*pct.change - seymour_fit$coefficients[1])/seymour_fit$coefficients[2]
x.20 = (4*pct.change - seymour_fit$coefficients[1])/seymour_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (seymour_fit$coefficients[2]*0.20) + seymour_fit$coefficients[1]

## average harvest rate when population increased
seymour %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr
# summary of results...add to results above????? 
sc <- data.frame(cbind("seymour", summary(seymour_fit)$coefficients[2,4], summary(seymour_fit)$r.squared, 
                       (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2]),
                       mean(seymour$adj_hrate),mean(seymour$change_b)),x.05, x.10, y.20, 
                 inc_avg_hr, mean(seymour$mature))

colnames(sc) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")
rownames(sc) <- c("adj.hr")

### Peril  -----
adjustments %>% 
  filter(area == "Peril")

bio_har_allareas %>% 
  filter(area == "peril") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 2.753328*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> peril

# visualization ----
peril_fig <- ggplot(peril, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.037) +
  ggtitle("Peril") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")
# save plot for text document
png('./figures/peril.png', res= 300, width = 6.5, height = 4.0, units = "in")
peril_fig
dev.off()
# linear regression ----
peril_fit <- lm(change_b ~ adj_hrate, data = peril)
summary(peril_fit)

# 1989 apprears to be an outlier....the change in biomass is greater than 2.
peril %>% 
  filter(season != 1989) -> peril_89
peril_fit2 <- lm(change_b ~ adj_hrate, data = peril_89)
summary(peril_fit2)
ggplot(peril_89, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# Equilibrium harvest rate ------
# when y = 0
# (-peril_fit$coefficients[1]/peril_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - peril_fit$coefficients[1])/peril_fit$coefficients[2]
x.10 = (2*pct.change - peril_fit$coefficients[1])/peril_fit$coefficients[2]
x.20 = (4*pct.change - peril_fit$coefficients[1])/peril_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (peril_fit$coefficients[2]*0.20) + peril_fit$coefficients[1]
## average harvest rate when population increased
peril %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr
# summary of results...add to results above????? 
ps <- data.frame(cbind("peril", summary(peril_fit)$coefficients[2,4], summary(peril_fit)$r.squared, 
                       (-peril_fit$coefficients[1]/peril_fit$coefficients[2]),
                       mean(peril$adj_hrate),mean(peril$change_b)),x.05, x.10, y.20, 
                 inc_avg_hr, mean(peril$mature))

colnames(ps) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")
rownames(ps) <- c("adj.hr")

### Excursion  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Excursion")

bio_har_allareas %>% 
  filter(area == "excursion") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 2.945864*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> excursion

# visualization ----
excursion_fig <- ggplot(excursion, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.060) +
  ggtitle("Excursion") + xlab("Harvest Rate") + 
  ylab("Change in Adjusted (using m-r) Mature Biomass")
# save plot for text document
png('./figures/excursion.png', res= 300, width = 6.5, height = 4.0, units = "in")
excursion_fig
dev.off()
# linear regression ----
excursion_fit <- lm(change_b ~ adj_hrate, data = excursion)
summary(excursion_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-excursion_fit$coefficients[1]/excursion_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - excursion_fit$coefficients[1])/excursion_fit$coefficients[2]
x.10 = (2*pct.change - excursion_fit$coefficients[1])/excursion_fit$coefficients[2]
x.20 = (4*pct.change - excursion_fit$coefficients[1])/excursion_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (excursion_fit$coefficients[2]*0.20) + excursion_fit$coefficients[1]

excursion %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(adj_hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr
# summary of results...add to results above????? 
ei <- data.frame(cbind("excursion", summary(excursion_fit)$coefficients[2,4], summary(excursion_fit)$r.squared, 
                       (-excursion_fit$coefficients[1]/excursion_fit$coefficients[2]),
                       mean(excursion$adj_hrate),mean(excursion$change_b)),x.05, x.10, y.20, 
                 inc_avg_hr, mean(excursion$mature))

colnames(ei) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                  "avg mature lb")
rownames(ei) <- c("adj.hr")

### Juneau  -----
# No adjustments for Juneau since no mark-recapture here.

bio_har_allareas %>% 
  filter(area == "juneau") %>% 
  mutate(mature_1 = c(mature[2:40], 0), change_b = (mature_1-mature)/mature) %>% 
  filter(year < 2018) -> juneau

# visualization ----
juneau_fig <- ggplot(juneau, aes(hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.173) +
  ggtitle("Juneau") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass")
# save plot for text document
png('./figures/juneau.png', res= 300, width = 6.5, height = 4.0, units = "in")
juneau_fig
dev.off()
# linear regression ----
juneau_fit <- lm(change_b ~ hrate, data = juneau)
summary(juneau_fit)

d = data.frame(juneau, predict(juneau_fit, interval = "prediction"))
d$residuals = residuals(juneau_fit)

ggplot(d, aes(hrate, change_b)) +
  geom_line(aes(y=lwr), color = "red", linetype = "dashed") +
  geom_line(aes(y=upr), color = "red", linetype = "dashed") +
  geom_smooth(method =  "lm") +
  #geom_smooth(method = "lm", se=FALSE, color = 'blue') +
  geom_point() 
# Equilibrium harvest rate ------
# when y = 0
# (-juneau_fit$coefficients[1]/juneau_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - juneau_fit$coefficients[1])/juneau_fit$coefficients[2]
x.10 = (2*pct.change - juneau_fit$coefficients[1])/juneau_fit$coefficients[2]
x.20 = (4*pct.change - juneau_fit$coefficients[1])/juneau_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (juneau_fit$coefficients[2]*0.20) + juneau_fit$coefficients[1]
## average harvest rate when population increased
juneau %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(hrate)) %>% 
  as.data.frame() %>% 
  filter(direction == "positive") %>% 
  select(avg_hrate) -> inc_avg_hr

# summary of results...add to results above????? 
jnu <- data.frame(cbind("juneau", summary(juneau_fit)$coefficients[2,4], summary(juneau_fit)$r.squared, 
                       (-juneau_fit$coefficients[1]/juneau_fit$coefficients[2]),
                       mean(juneau$hrate),mean(juneau$change_b)),x.05, x.10, y.20, 
                  inc_avg_hr, mean(juneau$mature))

colnames(jnu) <- c("area", "p.value", "r.squared", "equ.er.adj", "avg.hr", "avg.pop.change", 
                   "HR at -5%", "HR at -10%", "Pop change at 20% hrate", "avg.inc.hr", 
                   "avg mature lb")
rownames(jnu) <- c("not_adjusted")

## juneau subset ------
juneau %>% 
  mutate(timeperiod = ifelse(year > 1989 & year < 2000, "incline", 
                             ifelse(year > 1999 & year < 2013, "decline", 
                                    ifelse(year > 2012, "current", "pre-1990")))) -> juneau
# visualization ----
juneau_fig1 <-   ggplot(juneau, aes(hrate, change_b)) +
  geom_point(aes(color = timeperiod, shape = timeperiod), size =3) +
  scale_colour_manual(name="", values = c("darkorchid", "red", "chartreuse3", "black")) +
  scale_shape_manual(name = "", values = c(19,6,17,20)) +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.173) +
  ggtitle("Juneau (1979 - 2017) - equil rate 17%") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass")
# save plot for text document
png('./figures/juneau1.png', res= 300, width = 6.5, height = 4.0, units = "in")
juneau_fig1
dev.off()

## fig1 with text -----
juneau_fig1a <- ggplot(juneau, aes(hrate, change_b, label = year)) +
  geom_point(aes(color = timeperiod, shape = timeperiod), size =3) +
  scale_colour_manual(name="", values = c("darkorchid", "red", "chartreuse3", "black")) +
  scale_shape_manual(name = "", values = c(19,6,17,20)) +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.173) +
  ggtitle("Juneau (1979 - 2017) - equil rate 17%") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass") +
  geom_text(hjust = 0.5, vjust = 1, nudge_y = -0.01, size = 2)
# save plot for text document
png('./figures/juneau1a.png', res= 300, width = 7.5, height = 3.5, units = "in")
juneau_fig1a
dev.off()


## juneau low abundance years (2000-2012) --------
juneau %>% 
  filter(year > 1999 & year < 2013) -> juneau2
juneau_fit2 <- lm(change_b ~ hrate, data = juneau2)
summary(juneau_fit2)

# Equilibrium harvest rate 
# when y = 0
# (-juneau_fit2$coefficients[1]/juneau_fit2$coefficients[2])
juneau_fig2 <- ggplot(juneau2, aes(hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.059) +
  ggtitle("Juneau (decline/low abundance 2000-2012) - equil rate 6%") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass")
# save plot for text document
png('./figures/juneau2.png', res= 300, width = 6.5, height = 4.0, units = "in")
juneau_fig2
dev.off()

## juneau baseline years (1993-2007) ------
juneau %>% 
  filter(year > 1992 & year < 2008) -> juneau3
juneau_fit3 <- lm(change_b ~ hrate, data = juneau3)
summary(juneau_fit3)

# Equilibrium harvest rate 
# when y = 0
# (-juneau_fit3$coefficients[1]/juneau_fit3$coefficients[2])
juneau_fig3 <- ggplot(juneau3, aes(hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.20) +
  ggtitle("Juneau (baseline 1993-2007) - equil rate 20%") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass")
# save plot for text document
png('./figures/juneau3.png', res= 300, width = 6.5, height = 4.0, units = "in")
juneau_fig3
dev.off()

## juneau increasing abundance (1990-1999) ------
juneau %>% 
  filter(year > 1989 & year < 2000) -> juneau4
juneau_fit4 <- lm(change_b ~ hrate, data = juneau4)
summary(juneau_fit4)

# Equilibrium harvest rate 
# when y = 0
# (-juneau_fit4$coefficients[1]/juneau_fit4$coefficients[2])
juneau_fig4 <- ggplot(juneau4, aes(hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.248) +
  ggtitle("Juneau (incline/high abundance 1990-1999) - equil rate 25%") + xlab("Harvest Rate") + 
  ylab("Change in Mature Biomass")
# save plot for text document
png('./figures/juneau4.png', res= 300, width = 6.5, height = 4.0, units = "in")
juneau_fig4
dev.off()

## juneau avg increase vs decrease -----
juneau %>% 
  mutate(direction = ifelse(change_b >= 0, "positive",
                            ifelse(change_b <0, "negative", NA))) %>% 
  group_by(direction) %>% 
  summarise(avg_change = mean(change_b), avg_hrate = mean(hrate))

## all results -------
pb %>% 
  rbind(gb) %>% 
  rbind(sc) %>% 
  rbind(ps) %>% 
  rbind(ls) %>% 
  rbind(ei) %>% 
  rbind(jnu) -> results_all2

write.csv(results_all2, './results/table_all_results.csv')

results_all2 %>% 
  mutate(p.value = round(as.numeric(as.character(p.value)), 4), 
         r.squared = round(as.numeric(as.character(r.squared)), 4), 
         equ.er.adj = round(as.numeric(as.character(equ.er.adj)), 4),
         avg.hr = round(as.numeric(as.character(avg.hr)), 4),
         avg.pop.change = round(as.numeric(as.character(avg.pop.change)), 4)) %>% 
  dplyr::select(area, p.value, r.squared, equ.er.adj, avg.hr, avg.pop.change, 
                'avg mature lb')-> equ_hr

equ_hr
## Table 1 ------
## save for table 1 here. "Equilibrium harvest rates using adjusted biomass"
write.csv(equ_hr, './results/equ_harvest_rate.csv')

## Table 2 -----------
### equ using averages NOT relationship 
# add the average harvest rate and the average population change to get the alt.equ.hr
equ_hr %>% 
  mutate(alt.equ.hr = avg.hr + avg.pop.change) -> equ_hr2

write.csv(equ_hr2, './results/equ_harvest_rate_alt.csv')

## Table 3 -------
# similar to table 2 but add in avg.inc.hr
results_all2 %>% 
  mutate(p.value = round(as.numeric(as.character(p.value)), 4), 
         r.squared = round(as.numeric(as.character(r.squared)), 4), 
         equ.er.adj = round(as.numeric(as.character(equ.er.adj)), 4),
         avg.hr = round(as.numeric(as.character(avg.hr)), 4),
         avg.pop.change = round(as.numeric(as.character(avg.pop.change)), 4), 
         avg.inc.hr = round(as.numeric(as.character(avg.inc.hr)),4)) %>% 
  dplyr::select(area, p.value, r.squared, equ.er.adj, avg.hr, avg.pop.change,
                avg.inc.hr, 'avg mature lb')-> equ_hr3
write.csv(equ_hr3, './results/table3.csv')
### risk increasing -----
# determine harvest rates that would be equivalent to a certain amount of decrease in biomass
# 5%, 10% "risk" or decrease in population, along with change in population at 20% HR

results_all2 %>% 
  dplyr::select(-p.value, -r.squared) %>% 
  mutate(equ.er.adj = round(as.numeric(as.character(equ.er.adj)), 4),
         avg.hr = round(as.numeric(as.character(avg.hr)), 4),
         avg.pop.change = round(as.numeric(as.character(avg.pop.change)), 4), 
         risk.5pct = round(`HR at -5%`, 4), 
         risk.10pct = round(`HR at -10%`, 4), 
         change.20pct.HR = round(`Pop change at 20% hrate`, 4), 
         alt.equ.hr = avg.hr + avg.pop.change) %>%
  dplyr::select(area, equ.er.adj, alt.equ.hr, risk.5pct, risk.10pct, change.20pct.HR) -> risk1

write.csv(risk1, './results/risk_using_equhr.csv')
