# redo of a 2013 analysis looking at an "equlibrium" harvest rate (a harvest rate where the overall change in 
#     in the population would be 0).
# This analysis uses southeast alaksa red king crab data. But could be applied to other populations.

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-3-23

# load ---
source('./code/packages.R')

# data -----
# Data is sourced from two place.  Annual biomas estimates are from the output of the CSA model for each area
#     in 2017 (stored in excel files for sharability with name of area). Harvest is taken from fish tickets
#     the files here are from the old fish ticket data base (prior to 1985) and the new database.  
#       **FLAG** These values need to be checked with ALEX output to make sure they are pulling the correct harvest

biomass <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet1") 
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")

harvest1 <- read.csv('data/old_fish_tickets.csv')
harvest2 <- read.csv('data/fish_tickest_rkc_newer.csv')


# data clean up --------
# old fish ticket data base
harvest1 %>% 
  rename(year = Ã¯..Year.Landed, stat.area = Stat.Area, pounds = Pounds, species = Species.Code) %>% 
  mutate(season = ifelse(Month.Landed >=7, year, year-1)) ->harvest1
# after consulting with Karla and BOF report season most likely started around July and went until the next spring.

harvest1 %>% 
  group_by(season, stat.area, species) %>% 
  summarise(pounds = sum(pounds)) -> harvest_74_84

# new fish ticket data base
harvest2 %>% 
  rename(year = DOL.Year, stat.area = Stat.Area, pounds = Landed.Weight..sum., species.name = Species.Name) %>% 
  mutate(season = ifelse(DOL.Month >=7, year, year-1)) ->harvest2

harvest2 %>% 
  group_by(season, stat.area, species.name) %>% 
  summarise(pounds = sum(pounds)) -> harvest_88_17

# create one file for harvest.  Old one has species code, new one has species name
harvest_74_84 %>% 
  select(-species) -> harv_a
harvest_88_17 %>% 
  select(-species.name) -> harv_b

harv_a %>% 
  bind_rows(harv_b) -> harvest

## assign ---
## assign stat areas with harvest

harvest %>% 
  left_join(survey.area) -> test

## summary by year and survey area ----
# group by survey area and year

test %>% 
  group_by(suvery.area, season) %>% 
  summarise(pounds = sum(pounds, na.rm = TRUE)) %>% 
  filter( !is.na(suvery.area)) %>% 
  mutate(area = suvery.area)-> harvest_by_sa

## biomass and harvest combined -----
biomass %>% 
  mutate(season = year) -> biomass

# added column for mature biomass in the next year to make these calculations easier. Mature_1 is mature year +1
biomass %>% 
  left_join(harvest_by_sa) %>% 
  mutate(hrate = pounds/mature) %>% 
  mutate(mature_1 = c(mature[2:274], 0), change_b = (mature_1 - mature)/mature) -> bio_har_allareas

## Lynn Sisters -----
# use this area as example and then do analysis for all areas

