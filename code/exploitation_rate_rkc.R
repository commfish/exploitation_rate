# redo of a 2013 analysis looking at an "equlibrium" harvest rate (a harvest rate where the overall change in 
#     in the population would be 0).
# This analysis uses southeast alaksa red king crab data. But could be applied to other populations.

# K.Palof    ADF&G 
# katie.palof@alaska.gov
# 2018-3-23

# load ---
source('./code/packages.R')

# data -----
# Data is sourced from three place.  1) Annual biomas estimates are from the output of the CSA model for each area
#     in 2017 (stored in excel files for sharability with name of area). 
 #  2) Harvest is taken from fish tickets
#     the files here are from the old fish ticket data base (prior to 1985) and the new database. OR
#         option file is from ALEX with all years combined.
#       **FLAG** These values need to be checked with ALEX output to make sure they are pulling the correct harvest

#  personal use summary is take from statewide harvest survey data and permit data in Juneau area
#     these are summarized in an excel file: Catch 2017_Analysis_updated from 2005.xls

biomass <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet1") 
# file to convert stat areas into survey areas
survey.area <- read.xlsx('data/rkc_biomass_2017_model.xlsx', sheetName = "Sheet2")

## if using OceanAK use these files - old and new databases seperate
harvest1 <- read.csv('data/old_fish_tickets.csv')
harvest2 <- read.csv('data/fish_tickest_rkc_newer.csv')

## if using ALEX output use this file
harvest <- read.xlsx('data/RKC and BKC historical data - Reg Area A.xlsx', sheetName = "Rinput")

# file for adjustments between mark recapture and CSA biomass estimates.  Results of the mark-
#   recapture analysis - this is taken directly from the output of that in it's R project
adjustments <- read.csv('data/adj_final_stock_assessment.csv')

# personal use data, from excel file. Include numbers of crab and legal weight from survey
#     convert to pounds.
per_use <- read.xlsx('data/personal_use_all.xlsx', sheetName = "Sheet1")

# data clean up with Ocean AK data--------
# old fish ticket data base
harvest1 %>% 
  rename(year = Ã¯..Year.Landed, stat.area = Stat.Area, pounds = Pounds, species = Species.Code) %>% 
  mutate(season = ifelse(Month.Landed >=7, year, year-1)) ->harvest1
# after consulting with Karla and BOF report season most likely started around July and went until the next spring.

harvest1 %>% 
  group_by(season, stat.area, species) %>% 
  summarise(pounds = sum(pounds)) -> harvest_74_84

# new fish ticket data base
harvest2 %>% 
  rename(year = DOL.Year, stat.area = Stat.Area, pounds = Landed.Weight..sum., species.name = Species.Name) %>% 
  mutate(season = ifelse(DOL.Month >=7, year, year-1)) ->harvest2

harvest2 %>% 
  group_by(season, stat.area, species.name) %>% 
  summarise(pounds = sum(pounds)) -> harvest_88_17

# create one file for harvest.  Old one has species code, new one has species name
harvest_74_84 %>% 
  select(-species) -> harv_a
harvest_88_17 %>% 
  select(-species.name) -> harv_b

harv_a %>% 
  bind_rows(harv_b) -> harvest_oak

## data clean up - ALEX harvest file -----------
harvest %>% 
  rename(year = YEAR, cdate = CATCH_DATE, season = SEASON, numbers = NUMBERS, pounds = POUNDS) %>% 
  select(year, TICKET_NO, cdate, season, I_FISHERY, STAT_AREA, DISTRICT, SUB_DISTRICT, 
         SPECIES_CODE, numbers, pounds, POTS) -> harvest_all

## file for use by others------  see survey_non_rkc.R 
#harvest %>% 
#  left_join(survey.area) %>% 
#  mutate(area_type = ifelse(is.na(survey.area), "non", "survey"))-> harvest_file1

#write.csv(harvest_file1, './results/all_years_harvest_survey_non.csv')
## assign ------
## assign stat areas with harvest

harvest_all %>% 
  left_join(survey.area) %>% 
  mutate(area_type = ifelse(is.na(survey.area), "non", "survey")) -> harvest_all_areas

## summary by year and survey area ----
# group by survey area and year

harvest_all_areas %>% 
  group_by(survey.area, season) %>% 
  summarise(pounds = sum(pounds, na.rm = TRUE)) %>% 
  filter( !is.na(survey.area)) %>% 
  mutate(area = survey.area)-> harvest_by_sa


# need a season reference column in terms of years
library(stringr)
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
} 

harvest_by_sa %>% 
  mutate(year = as.numeric(ifelse(season == "Jan1969 - Aug69", 1968, numextract(season)))) -> harvest_by_sa

# add personal use harvest to commercial harvest
per_use %>% 
  mutate(pu_pounds = pu_number * legal_weight) -> per_use

harvest_by_sa %>% 
  left_join(per_use) %>% 
  mutate(total_pounds = ifelse(!is.na(pu_pounds), 
                               pounds + pu_pounds, pounds)) -> total_harvest_by_sa

## biomass and harvest combined -----

biomass %>% 
  left_join(total_harvest_by_sa) %>% 
  mutate(total_pounds = ifelse(is.na(total_pounds),0, total_pounds)) %>% 
  mutate(hrate = total_pounds/mature)  -> bio_har_allareas # need to replace NA in hrate with 0 to show no harvest

# this doesn't work when all areas are combined....can do this one I seperate out area
# added column for mature biomass in the next year to make these calculations easier. Mature_1 is mature year +1


## Lynn Sisters -----
# use this area as example and then do analysis for all areas
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "St_James")

bio_har_allareas %>% 
  filter(area == "lynn") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 1.746833*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> lynn

# lynn visualization ----
ggplot(lynn, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)


# Lynn  linear regression -----
lynn_fit <- lm(change_b ~ adj_hrate, data = lynn)
summary(lynn_fit)
#summary(lynn_fit)$coefficients
#summary(lynn_fit)$r.squared

# Equilibrium harvest rate ------
# when y = 0
# (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.10 = (2*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.20 = (4*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (lynn_fit$coefficients[2]*0.20) + lynn_fit$coefficients[1]

# building lynn results....add to this? 
results <- data.frame(cbind("lynn", summary(lynn_fit)$coefficients[2,4], summary(lynn_fit)$r.squared, 
      (-lynn_fit$coefficients[1]/lynn_fit$coefficients[2]),
      mean(lynn$adj_hrate),mean(lynn$change_b)), x.05, x.10, y.20)

rownames(results) <- c("adj.hr")
colnames(results) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change", 
                       "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

### Pybus  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Pybus")

bio_har_allareas %>% 
  filter(area == "pybus") %>% 
  mutate(mature_1 = c(mature[2:40], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.080614*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> pybus

# visualization ----
ggplot(pybus, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
pybus_fit <- lm(change_b ~ adj_hrate, data = pybus)
summary(pybus_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]
x.10 = (2*pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]
x.20 = (4*pct.change - pybus_fit$coefficients[1])/pybus_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (pybus_fit$coefficients[2]*0.20) + pybus_fit$coefficients[1]

# summary of results...add to results above????? 
pb <- data.frame(cbind("pybus", summary(pybus_fit)$coefficients[2,4], summary(pybus_fit)$r.squared, 
                 (-pybus_fit$coefficients[1]/pybus_fit$coefficients[2]),
                 mean(pybus$adj_hrate),mean(pybus$change_b)), x.05, x.10, y.20)

colnames(pb) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change", 
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

results %>% 
  rbind(pb) ->results_all

### Gambier  -----
adjustments %>% 
  filter(area == "Gambier")

bio_har_allareas %>% 
  filter(area == "gambier") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 3.929303*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> gambier

# visualization ----
ggplot(gambier, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
gambier_fit <- lm(change_b ~ adj_hrate, data = gambier)
summary(gambier_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2])

## Harvest rate when population change is -5%, y = -.05
pct.change = -0.05
x.05 = (pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.10 = (2*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]
x.20 = (4*pct.change - lynn_fit$coefficients[1])/lynn_fit$coefficients[2]

## Population change when harvest rate = 0.20
y.20 = (lynn_fit$coefficients[2]*0.20) + lynn_fit$coefficients[1]

# summary of results...add to results above????? 
gb <- data.frame(cbind("gambier", summary(gambier_fit)$coefficients[2,4], summary(gambier_fit)$r.squared, 
                       (-gambier_fit$coefficients[1]/gambier_fit$coefficients[2]),
                       mean(gambier$adj_hrate),mean(gambier$change_b)),x.05, x.10, y.20)

colnames(gb) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change",
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

results_all %>% 
  rbind(gb) ->results_all

### Seymour  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Seymour")

bio_har_allareas %>% 
  filter(area == "seymour") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 9.174725*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> seymour

# visualization ----
ggplot(seymour, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
seymour_fit <- lm(change_b ~ adj_hrate, data = seymour)
summary(seymour_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2])

# summary of results...add to results above????? 
sc <- data.frame(cbind("seymour", summary(seymour_fit)$coefficients[2,4], summary(seymour_fit)$r.squared, 
                       (-seymour_fit$coefficients[1]/seymour_fit$coefficients[2]),
                       mean(seymour$adj_hrate),mean(seymour$change_b)),x.05, x.10, y.20)

colnames(sc) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change",
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

results_all %>% 
  rbind(sc) ->results_all

### Peril  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Peril")

bio_har_allareas %>% 
  filter(area == "peril") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 2.753328*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> peril

# visualization ----
ggplot(peril, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
peril_fit <- lm(change_b ~ adj_hrate, data = peril)
summary(peril_fit)

# 1989 apprears to be an outlier....the change in biomass is greater than 2.
peril %>% 
  filter(season != 1989) -> peril_89
peril_fit2 <- lm(change_b ~ adj_hrate, data = peril_89)
summary(peril_fit2)
ggplot(peril_89, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# Equilibrium harvest rate ------
# when y = 0
# (-peril_fit$coefficients[1]/peril_fit$coefficients[2])

# summary of results...add to results above????? 
ps <- data.frame(cbind("peril", summary(peril_fit)$coefficients[2,4], summary(peril_fit)$r.squared, 
                       (-peril_fit$coefficients[1]/peril_fit$coefficients[2]),
                       mean(peril$adj_hrate),mean(peril$change_b)),x.05, x.10, y.20)

colnames(ps) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change",
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

results_all %>% 
  rbind(ps) ->results_all

### Excursion  -----
# use hrate2 - has 0's instead of NAs.
adjustments %>% 
  filter(area == "Excursion")

bio_har_allareas %>% 
  filter(area == "excursion") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature, 
         adj_mature = 2.945864*mature, adj_hrate =  total_pounds/adj_mature) %>% 
  filter(year < 2017) -> excursion

# visualization ----
ggplot(excursion, aes(adj_hrate, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
excursion_fit <- lm(change_b ~ adj_hrate, data = excursion)
summary(excursion_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-excursion_fit$coefficients[1]/excursion_fit$coefficients[2])

# summary of results...add to results above????? 
ei <- data.frame(cbind("excursion", summary(excursion_fit)$coefficients[2,4], summary(excursion_fit)$r.squared, 
                       (-excursion_fit$coefficients[1]/excursion_fit$coefficients[2]),
                       mean(excursion$adj_hrate),mean(excursion$change_b)),x.05, x.10, y.20)

colnames(ei) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change",
                  "HR at -5%", "HR at -10%", "Pop change at 20% hrate")

results_all %>% 
  rbind(ei) ->results_all

### Juneau  -----
# use hrate2 - has 0's instead of NAs.
#adjustments %>% 
#  filter(area == "Excursion") no adjustment for juneau 

bio_har_allareas %>% 
  filter(area == "juneau") %>% 
  mutate(mature_1 = c(mature[2:39], 0), change_b = (mature_1-mature)/mature) %>% 
  filter(year < 2017) -> juneau

# visualization ----
ggplot(juneau, aes(hrate2, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
juneau_fit <- lm(change_b ~ hrate2, data = juneau)
summary(juneau_fit)

# Equilibrium harvest rate ------
# when y = 0
# (-juneau_fit$coefficients[1]/juneau_fit$coefficients[2])

# summary of results...add to results above????? 
jnu <- data.frame(cbind("juneau", summary(juneau_fit)$coefficients[2,4], summary(juneau_fit)$r.squared, 
                       (-juneau_fit$coefficients[1]/juneau_fit$coefficients[2]),
                       mean(juneau$hrate2),mean(juneau$change_b)),x.05, x.10, y.20)

colnames(jnu) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change",
                   "HR at -5%", "HR at -10%", "Pop change at 20% hrate")
rownames(jnu) <- c("not_adjusted")

#results_all %>% 
#  rbind(jnu) ->results_all

# check peril - was alot larger was 9% using averages 
# check juneau - was 17 % not only 9.....
### Juneau issues with harvest reported ------------
# no personal use harvest is included - fix this by including an estimate from personal use permits in years available
jnu_pu <- read.csv('data/jnu_personaluse_allyrs.csv')

# reduce data for simplification
jnu_pu %>% 
  rename(year = Year, permit.no = Permit.Number, status = Permit.Returned.Status, 
         line.no = Line.Number, catch.date = Catch.Date,
         no.crab = Number.Of.Crab, no.pots = Number.Of.Pots) %>% 
  select(year, permit.no, status, line.no, catch.date, no.crab, no.pots) -> jnu_pu2

# personal use totals by permit return status
jnu_pu2 %>% 
  group_by(year, status) %>% 
  summarise(crab = sum(no.crab, na.rm = TRUE), permits = n_distinct(permit.no)) -> pu_status

# calculate personal use totals by year
jnu_pu2 %>% 
  group_by(year) %>% 
  summarise(crab = sum(no.crab, na.rm = TRUE), permits = n_distinct(permit.no)) -> pu

# harvest is off by alot from what is being used in CSA model... why? check logbook data
jnu_logbk <- read.xlsx('data/logbook_jnu_allyrs.xlsx', sheetName = "Sheet1") 

jnu_logbk %>% 
  rename(year = YEAR, fishery = I_FISHERY_CODE, source = DATA_SOURCE, ticket.no = TICKET_NO, 
         effort.date = EFFORT_DATE, no.crab = TARGET_SPECIES_RETAINED) %>% 
  select(year, fishery, source, ticket.no, effort.date, no.crab) -> jnu_logbk2
# reduce data and clean up
jnu_logbk2 %>% 
  filter(source == 'logbook') -> jnu_logbk2
jnu_logbk2 %>% 
  group_by(year) %>% 
  summarise(no.crab = sum(no.crab))

### Juneau redo ----
head(juneau)
pu_jnu <- read.xlsx('data/juneau_issues.xlsx', sheetName = "Sheet2")

juneau %>% 
  left_join(pu_jnu) -> juneau

juneau %>% 
  mutate(total_pounds = pounds + pu_pounds, hrate3 = total_pounds/mature) -> juneau
#juneau %>% mutate(hrate2 = ifelse(is.na(hrate), 0, hrate)

### visualization -----
ggplot(juneau, aes(hrate3, change_b)) +
  geom_point() +
  geom_smooth(method= lm) +
  geom_hline(yintercept = 0)

# linear regression ----
juneau_fit2 <- lm(change_b ~ hrate3, data = juneau)
summary(juneau_fit2)
# Equilibrium harvest rate ------
# when y = 0
# (-juneau_fit$coefficients[1]/juneau_fit$coefficients[2])

# summary of results...add to results above????? 
jnu2 <- data.frame(cbind("juneau", summary(juneau_fit2)$coefficients[2,4], summary(juneau_fit2)$r.squared, 
                        (-juneau_fit2$coefficients[1]/juneau_fit2$coefficients[2]),
                        mean(juneau$hrate3),mean(juneau$change_b)))

colnames(jnu2) <- c("area", "p.value", "r.squared", "equ.hr.adj", "avg.hr", "avg.pop.change")
rownames(jnu2) <- c("not_adjusted")

results_all %>% 
  rbind(jnu2) ->results_all


### Peril harvest issues ------


## all results -------
results_all %>% 
  mutate(p.value = round(as.numeric(as.character(p.value)), 5), 
         r.squared = round(as.numeric(as.character(r.squared)), 5), 
         equ.hr.adj = round(as.numeric(as.character(equ.hr.adj)), 5),
         avg.hr = round(as.numeric(as.character(avg.hr)), 5),
         avg.pop.change = round(as.numeric(as.character(avg.pop.change)), 5)) -> equ_hr


### problems ----
equ_hr
### equ using averages NOT relationship -----


### risk increasing -----
# determine harvest rates that would be equivalent to a certain amount of decrease in biomass
## 10 % risk -----


